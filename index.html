<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wicked Willow • Curse of Atchison (QR Round 2)</title>
<meta name="theme-color" content="#111017">
<style>
  :root{ --bg:#0c0a12; --panel:#131022; --ink:#f0e6ff; --muted:#c8b8ffb3; --accent:#9ef0c9; --danger:#ff6b6b; --coin:#f6c945; --glow:#52ffb380; }
  *{box-sizing:border-box} html,body{height:100%}
  body{ margin:0; background: radial-gradient(1200px 700px at 70% -10%, #1b1533 0%, var(--bg) 45%, #09070f 100%); color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; line-height:1.55; overflow-x:hidden; }
  .stars{position:fixed; inset:0; pointer-events:none; z-index:0}
  .stars:before,.stars:after{content:""; position:absolute; inset:-50vh -50vw; background:
    radial-gradient(2px 2px at 10% 20%, #ffffff55 50%, transparent 60%),
    radial-gradient(2px 2px at 30% 80%, #ffffff33 50%, transparent 60%),
    radial-gradient(2px 2px at 70% 30%, #ffffff44 50%, transparent 60%),
    radial-gradient(2px 2px at 90% 60%, #ffffff22 50%, transparent 60%),
    radial-gradient(1.5px 1.5px at 50% 50%, #ffffff22 50%, transparent 60%);
    animation: drift 120s linear infinite; }
  .stars:after{animation-duration:160s; opacity:.6; filter:blur(.5px)}
  @keyframes drift{to{transform:translateY(40vh)}}
  header{ position:sticky; top:0; z-index:5; backdrop-filter: blur(8px); background:linear-gradient(180deg, #0f0c18dd, #0f0c18cc 60%, transparent); border-bottom:1px solid #30264a; box-shadow: 0 10px 30px #000d; }
  .wrap{max-width:940px; margin:0 auto; padding:16px}
  .title{display:flex; gap:12px; align-items:center; justify-content:space-between;}
  .brand{display:flex; gap:14px; align-items:center;}
  .sigil{ width:40px; height:40px; border-radius:50%; background: conic-gradient(from 210deg, #3efac4, #8bdcff, #b28bff, #3efac4); box-shadow: 0 0 16px var(--glow), inset 0 0 12px #0009; position:relative; }
  .sigil:after{content:"★"; position:absolute; inset:0; display:grid; place-items:center; color:#0a0a12; font-size:18px; text-shadow:0 0 10px #000;}
  h1{margin:0; font-weight:800; letter-spacing:.5px; font-size:20px}
  .progress{display:flex; align-items:center; gap:8px; margin-top:10px;}
  .bar{flex:1; height:10px; background:#1b1730; border-radius:99px; overflow:hidden; box-shadow: inset 0 0 0 1px #30264a;}
  .bar > i{display:block; height:100%; width:0%; background:linear-gradient(90deg, #48f8c5, #b693ff); box-shadow: 0 0 16px var(--glow) inset, 0 0 12px var(--glow)}
  .coins{display:flex; gap:6px}
  .coin{ width:22px; height:22px; border-radius:50%; background: radial-gradient(circle at 30% 30%, #fff8 0 20%, transparent 21%), linear-gradient(145deg, #ffeaa6, var(--coin));
         border:1px solid #e0b94a; box-shadow: inset 0 0 6px #966f00, 0 2px 4px #000a; transform:translateY(0); transition:transform .2s ease, filter .2s ease; filter:grayscale(100%) opacity(.4);}
  .coin.got{filter:none} .coin:hover{transform:translateY(-2px)}
  .actions{display:flex; gap:8px}
  button,.pill{ background:linear-gradient(180deg, #1d1733, #151029); border:1px solid #3c3161; color:var(--ink); padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:700; box-shadow: 0 6px 16px #0009, inset 0 0 0 1px #0006; }
  button:hover{border-color:#6e5bc6}
  .grid{display:grid; gap:16px; grid-template-columns:1fr; padding:20px 16px 56px;}
  @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
  .card{ background: linear-gradient(180deg, #17122b, #100c1d); border:1px solid #30264a; border-radius:16px; box-shadow: 0 20px 50px #000c, inset 0 0 0 1px #0008; position:relative; overflow:hidden;}
  .card .head{ padding:16px; display:flex; align-items:center; gap:10px; border-bottom:1px solid #2a2243; background: linear-gradient(180deg, #1a1433, transparent); }
  .tag{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #39465a; color:#a7c5c0; background: linear-gradient(180deg, #0f1e1a, #0b1412);}
  .card h2{margin:0; font-size:18px}
  .card .body{padding:16px; color:var(--muted)}
  .letter{background:#0e1520; border:1px dashed #3a4455; border-radius:12px; padding:12px; margin:10px 0; position:relative;}
  .letter:before{content:"Wax Seal"; position:absolute; right:-8px; top:-8px; font-size:10px; padding:6px 8px; border-radius:8px; background:linear-gradient(180deg, #2d243f, #1d1630); border:1px solid #4b3a77; color:#d9c8ff; box-shadow:0 6px 14px #0008; transform:rotate(6deg) }
  .letter .content{margin-top:10px; text-align:center; font-style:italic; line-height:1.6; color:#e8defa;}
  .riddle-input{display:flex; gap:8px; margin-top:12px;}
  .riddle-input input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid #393057; background:#0f0c18; color:#f0e6ff;}
  .result{margin-top:8px; font-weight:700} .ok{color: var(--accent)} .no{color: var(--danger)}
  .hint{font-size:12px; color:#9db2a9}
  .footer{position:sticky; bottom:0; z-index:4; border-top:1px solid #2b2341; background:linear-gradient(0deg, #0f0c18dd, #0f0c18cc 60%, transparent);}
  .ritual{display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px 16px;}
  .ritual .status{font-weight:800; letter-spacing:.3px}
  #spellPane{display:none} #spellPane.open{display:block}
  .ritual .spell{background:#0f1522; border:1px solid #344; border-radius:12px; padding:12px; color:#cfe9e0;}
  dialog{ border:none; border-radius:16px; background:#140f24; color:var(--ink); max-width:640px; width:calc(100% - 28px);
          padding:0; box-shadow: 0 40px 120px #000f, inset 0 0 0 1px #2d2450; }
  dialog::backdrop{background:#0009}
  .modal-head{display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid #2d2450; background:#1a1530}
  .modal-body{padding:16px; color:var(--muted)}
  .x{background:transparent; border:1px solid #463a73; border-radius:10px; padding:6px 10px; color:#ddd; cursor:pointer}
  .hidden{display:none !important} .small{font-size:12px} .sep{height:1px; background:#2a2243; margin:12px 0}
  /* Jump scare */
  #scare { position:fixed; inset:0; background:#000; display:none; z-index:9999; align-items:center; justify-content:center; }
  #scare .flash { position:absolute; inset:0; background:radial-gradient(circle at 50% 50%, #ffffff, #ffd2d2 40%, #000 70%); opacity:0; }
  #scare .face { width:min(90vw,700px); height:auto; opacity:0; filter:drop-shadow(0 0 20px #000);
                 background-repeat:no-repeat; background-position:center; background-size:contain;
                 background-image:url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 700 700">\
<rect width="700" height="700" fill="black"/>\
<g fill="white">\
<ellipse cx="240" cy="260" rx="70" ry="95"/>\
<ellipse cx="460" cy="260" rx="70" ry="95"/>\
<path d="M210 480 Q350 620 490 480 Q350 520 210 480 Z" />\
</g>\
<g fill="black">\
<ellipse cx="240" cy="270" rx="28" ry="38"/>\
<ellipse cx="460" cy="270" rx="28" ry="38"/>\
</g>\
</svg>'); }
  .scare-in .flash{animation: flash 0.25s ease forwards} .scare-in .face{animation: popIn 0.28s ease forwards 0.05s}
  @keyframes popIn { from { transform:scale(0.65); opacity:0; } to { transform:scale(1); opacity:1; } }
  @keyframes flash { 0%{opacity:0} 40%{opacity:1} 100%{opacity:0.2} }
</style>
</head>
<body>
<div class="stars"></div>

<header>
  <div class="wrap">
    <div class="title">
      <div class="brand">
        <div class="sigil" aria-hidden="true"></div>
        <div>
          <h1>Wicked Willow · Curse of Atchison (QR)</h1>
          <div class="progress"><div class="bar"><i id="barFill" style="width:0%"></i></div>
            <div class="coins"><div class="coin" id="c1"></div><div class="coin" id="c2"></div><div class="coin" id="c3"></div><div class="coin" id="c4"></div><div class="coin" id="c5"></div></div>
          </div>
        </div>
      </div>
      <div class="actions">
        <button id="hintToggle" class="pill" aria-expanded="false">Hints: Off</button>
        <button id="reset" class="pill" title="Reset your progress">Reset</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <p class="small" style="color:var(--muted)">Mint 5 lore coins (riddles) → Round 2: roam, scan stickers, trade, survive Willow’s whispers → reach <b>10 coins</b> to unlock the ritual.</p>

  <div class="grid" id="grid">
    <!-- SECTION 1 -->
    <section class="card" id="s1"><div class="head"><span class="tag">1 · The Ridge</span><h2>Ashes & Echoes</h2></div>
      <div class="body">
        <p>Willow lit a broken lantern and spoke to the wind the night the mine collapsed.</p>
        <div class="letter"><strong>Lantern Note</strong><div class="content"><p>“Truth warned you, but greed made you deaf. If light returns to the lantern, the path might yet be seen.”</p></div></div>
        <p><strong>Riddle:</strong> I eat what I’m fed, yet I perish if I drink; I dance when I’m hungry and leave only char and stink. What am I?</p>
        <div class="riddle-input"><input id="a1" placeholder="Type your answer…"/><button data-check="1">Submit</button></div><div id="r1" class="result"></div>
        <p class="hint hidden" id="h1">Hint: Lanterns are its cradle; rain is its grave.</p>
      </div>
    </section>

    <!-- SECTION 2 -->
    <section class="card" id="s2"><div class="head"><span class="tag">2 · Mine Mouth</span><h2>The Warning</h2></div>
      <div class="body">
        <div class="letter"><strong>Miner’s Pocket Letter</strong><div class="content"><p>“If the song stops, turn back. No vein of coal is worth a widow’s veil.”</p></div></div>
        <p><strong>Riddle:</strong> I save you by surrendering breath, a sentinel whose voice foretells death. What am I?</p>
        <div class="riddle-input"><input id="a2" placeholder="Type your answer…"/><button data-check="2">Submit</button></div><div id="r2" class="result"></div>
        <p class="hint hidden" id="h2">Hint: A tiny singer in a cage.</p>
      </div>
    </section>

    <!-- SECTION 3 -->
    <section class="card" id="s3"><div class="head"><span class="tag">3 · The Dry River</span><h2>Salt & Bones</h2></div>
      <div class="body">
        <div class="letter"><strong>River-Binding Spell</strong><div class="content"><p>“Break my course and still my tongue; leave only salt upon my lungs.”</p></div></div>
        <p><strong>Riddle:</strong> With banks but no vault, a mouth without teeth, I flee to the ocean yet never grow feet. What am I?</p>
        <div class="riddle-input"><input id="a3" placeholder="Type your answer…"/><button data-check="3">Submit</button></div><div id="r3" class="result"></div>
        <p class="hint hidden" id="h3">Hint: Its bed is not for sleeping.</p>
      </div>
    </section>

    <!-- SECTION 4 -->
    <section class="card" id="s4"><div class="head"><span class="tag">4 · The Cottage</span><h2>The Mayor’s Head</h2></div>
      <div class="body">
        <div class="letter"><strong>Whisper from the Box</strong><div class="content"><p>“Heh… look what she left me—only weight on my words.”</p></div></div>
        <p><strong>Riddle:</strong> Read me forward and I burden you; read me backward and I bother you not. What am I?</p>
        <div class="riddle-input"><input id="a4" placeholder="Type your answer…"/><button data-check="4">Submit</button></div><div id="r4" class="result"></div>
        <p class="hint hidden" id="h4">Hint: A three-letter unit.</p>
      </div>
    </section>

    <!-- SECTION 5 -->
    <section class="card" id="s5"><div class="head"><span class="tag">5 · Town Square</span><h2>The Accusation</h2></div>
      <div class="body">
        <div class="letter"><strong>Willow’s Poem (Acrostic)</strong><div class="content">
          <p><span style="color:#9ef0c9;font-weight:bold">T</span>he hills remember what the town forgot.</p>
          <p><span style="color:#9ef0c9;font-weight:bold">R</span>estore the lantern; let blame burn out.</p>
          <p><span style="color:#9ef0c9;font-weight:bold">U</span>ndo the oath of anger with a single word.</p>
          <p><span style="color:#9ef0c9;font-weight:bold">C</span>ease your shouting; let silence mend.</p>
          <p><span style="color:#9ef0c9;font-weight:bold">E</span>nd what began in fear—begin again in truth.</p>
        </div></div>
        <p><strong>Question:</strong> Read the acrostic. Enter the single word to end the curse.</p>
        <div class="riddle-input"><input id="a5" placeholder="Type the one word…"/><button data-check="5">Submit</button></div><div id="r5" class="result"></div>
        <p class="hint hidden" id="h5">Hint: Take the first letter of each line.</p>
      </div>
    </section>

    <!-- ROUND 2 — Self-running -->
    <section class="card hidden" id="lvl2"><div class="head"><span class="tag">Round 2</span><h2>Willow’s Favor — Coin Hunt</h2></div>
      <div class="body">
        <p>Start with <b>5 coins</b> from the story. Wander. Scan stickers. Trade. Survive Willow’s whispers. Reach <b>10+ coins</b> to unlock the ritual.</p>

        <div class="letter"><strong>Your Pouch</strong><div class="content">
          <p>Codename: <input id="name" placeholder="e.g., LanternFox" style="width:60%;padding:6px;border-radius:8px;border:1px solid #393057;background:#0f0c18;color:#f0e6ff"> <button id="saveName" class="pill">Save</button></p>
          <p>Coins: <span id="coinTotal" style="font-weight:800;color:#9ef0c9">—</span></p>
        </div></div>

        <div class="letter"><strong>Scan Stickers</strong><div class="content">
          <p>Scan any sticker. If the camera won’t scan, tap and enter the printed token.</p>
          <p><button id="manualToken" class="pill">Enter Token</button></p>
          <div id="scanMsg" class="small"></div>
        </div></div>

        <div class="letter"><strong>Trade 1 Coin</strong><div class="content">
          <p><button id="showTrade" class="pill">Show Trade Code (Send 1)</button> <button id="recvTrade" class="pill">Receive 1 (Enter Code)</button></p>
          <div id="tradeArea" class="small"></div>
        </div></div>

        <div class="letter"><strong>Willow’s Whisper</strong><div class="content">
          <p>Random events appear now and then. Choose your fate…</p>
          <div id="whisperArea" class="small"></div>
        </div></div>
      </div>
    </section>
  </div>
</main>

<!-- Footer / Ritual -->
<footer class="footer">
  <div class="wrap ritual" id="ritual">
    <div>
      <div class="status" id="ritualStatus">Ritual Locked — collect 5 coins (story) to access Round 2.</div>
      <div class="small" style="color:var(--muted)">Ritual auto-unlocks when you have <b>10+</b> coins after Round 2.</div>
    </div>
    <div><button class="cast" id="castBtn" disabled>Perform Final Ritual</button></div>
  </div>
  <div class="wrap ritual spell" id="spellPane">
    <div class="sep"></div>
    <div class="spell">
      <p><strong>Final Rite of Unbinding</strong></p>
      <p style="color:#cfe9e0"><em>“Lantern rekindled, river released; song restored, and judgment ceased.<br>From ridge to square, let grudges part—<br>Return what’s owed and mend the heart.”</em></p>
      <p class="small">Gather in a circle. If your pouch holds 10 or more, speak the words and tap the button.</p>
      <button id="lift" class="pill">Lift the Curse</button>
    </div>
  </div>
</footer>

<!-- Jump Scare -->
<div id="scare" aria-hidden="true"><div class="flash"></div><div class="face" role="img" aria-label="Wicked Willow appears"></div></div>

<!-- Prize -->
<dialog id="prize">
  <div class="modal-head">
    <strong>✨ The Curse Lifts!</strong>
    <button class="x" data-close="prize" aria-label="Close">Close</button>
  </div>
  <div class="modal-body">
    <p>The wind softens, the river stirs, and the Mayor’s whisper fades at last.</p>
    <p><strong>Prize:</strong> Show this to the host for your reward.</p>
  </div>
</dialog>

<!-- Loser’s Curse popup -->
<dialog id="loser">
  <div class="modal-head">
    <strong>Loser’s Curse 😈</strong>
    <button class="x" data-close="loser" aria-label="Close">Close</button>
  </div>
  <div class="modal-body">
    <p>You’ve been <em>seriously</em> cursed. Pick one silly forfeit to clear it:</p>
    <ul>
      <li>Wear the Mayor’s mustache (drawn on finger) for 5 minutes.</li>
      <li>Speak only in rhyme for 2 minutes.</li>
      <li>Ask a stranger for a ghost story.</li>
    </ul>
    <p class="small">When done, take Willow’s pity: solve this tiny riddle for +1 back:</p>
    <p><em>“I have keys but open no doors; I have space but no rooms. What am I?”</em></p>
    <div class="riddle-input">
      <input id="loserAns" placeholder="answer…"/>
      <button id="loserSubmit" class="pill">Redeem +1</button>
    </div>
    <div id="loserMsg" class="small"></div>
  </div>
</dialog>

<script>
/* ====== Level 1 (Riddles) ====== */
const LVL1_ANS = {1:'fire',2:'canary',3:'river',4:'ton',5:'truce'};
const coins=[...document.querySelectorAll('.coin')];
const bar=document.getElementById('barFill');
const castBtn=document.getElementById('castBtn');
const ritualStatus=document.getElementById('ritualStatus');
const spellPane=document.getElementById('spellPane');
const scare=document.getElementById('scare');
const ids=['a1','a2','a3','a4','a5'], rs=['r1','r2','r3','r4','r5'], hs=['h1','h2','h3','h4','h5'];
const inputs=ids.map(id=>document.getElementById(id));
const results=rs.map(id=>document.getElementById(id));
const hints=hs.map(id=>document.getElementById(id));
document.getElementById('hintToggle').onclick=()=>toggleHints();
document.getElementById('reset').onclick=()=>{ if(confirm('Reset ALL progress?')){ localStorage.clear(); location.reload(); } };
document.addEventListener('click', (e)=>{ const btn=e.target.closest('[data-close]'); if(btn){ const id=btn.getAttribute('data-close'); const dlg=document.getElementById(id); if(dlg && dlg.close) dlg.close(); } });

function getState(){ try{return JSON.parse(localStorage.getItem('willow_qr')||'{}')}catch{return{}} }
function setState(s){ localStorage.setItem('willow_qr', JSON.stringify(s)); }
function ensureId(){ const s=getState(); if(!s.id){ s.id=crypto.randomUUID(); setState(s);} return s.id; }

function initLvl1(){
  const s=getState();
  for(let i=1;i<=5;i++){ if(s['s'+i]) award(i,false); }
  updateProgress();
  ids.forEach((id,idx)=>{
    const btn=document.querySelector(`button[data-check="${idx+1}"]`);
    btn.onclick=()=>check(idx+1);
    inputs[idx].addEventListener('keydown',e=>{ if(e.key==='Enter') check(idx+1); });
  });
  castBtn.onclick=()=>{ if(!castBtn.disabled){ openRitual(); } };
  document.getElementById('lift').onclick=async()=>{ await jumpScare(); const dlg=document.getElementById('prize'); if(dlg && dlg.showModal) dlg.showModal(); confetti(); };
}
function check(i){
  const val=(inputs[i-1].value||'').trim().toLowerCase();
  if(val===LVL1_ANS[i]){ results[i-1].textContent='Correct. Coin minted! ✨'; results[i-1].className='result ok'; award(i,true); updateProgress(); }
  else { results[i-1].textContent='Not quite. Try again.'; results[i-1].className='result no'; }
}
function award(i,animate){
  const s=getState(); if(!s['s'+i]){ s['s'+i]=true; setState(s); }
  coins[i-1].classList.add('got');
  if(animate) coins[i-1].animate([{transform:'scale(1)'},{transform:'scale(1.3)'},{transform:'scale(1)'}],{duration:550});
}

/* ====== Ritual gating (10+) ====== */
function updateProgress(){
  const s=getState(); const count=[1,2,3,4,5].filter(k=>s['s'+k]).length; bar.style.width=(count/5*100)+'%';
  // Unlock Round 2 after 5 story coins
  if(count===5){ document.getElementById('lvl2').classList.remove('hidden'); ritualStatus.textContent='Round 2 active — reach 10 coins to unlock the ritual.'; }
  else { ritualStatus.textContent=`Ritual Locked — ${5-count} coin(s) remaining in the story.`; }
  // Ritual unlock if coins >=10
  const currentCoins = (s.round2 && typeof s.round2.coins==='number') ? s.round2.coins : 0;
  const canRitual = (count===5 && currentCoins>=10);
  castBtn.disabled = !canRitual;
  if(canRitual) openRitual(true);
}
function openRitual(auto=false){
  spellPane.classList.add('open');
  document.getElementById('ritual').scrollIntoView({behavior:'smooth', block:'start'});
  if(!auto) confetti();
}
function toggleHints(){ const on=document.getElementById('hintToggle').getAttribute('aria-expanded')==='true';
  document.getElementById('hintToggle').setAttribute('aria-expanded', String(!on)); document.getElementById('hintToggle').textContent='Hints: '+(!on?'On':'Off');
  hints.forEach(h=>h.classList.toggle('hidden', on));
}

/* ====== Scare + confetti ====== */
function jumpScare(){ return new Promise(res=>{ scare.style.display='flex'; scare.classList.add('scare-in');
  try{ const C=window.AudioContext||window.webkitAudioContext; const ctx=new C();
    const N=2*ctx.sampleRate, nb=ctx.createBuffer(1,N,ctx.sampleRate), ch=nb.getChannelData(0);
    for(let i=0;i<N;i++) ch[i]=(Math.random()*2-1)*(1-i/N);
    const nsrc=ctx.createBufferSource(); nsrc.buffer=nb; const osc=ctx.createOscillator(); osc.type='sawtooth';
    osc.frequency.setValueAtTime(380, ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(40, ctx.currentTime+0.4);
    const g=ctx.createGain(); g.gain.setValueAtTime(0.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.8, ctx.currentTime+0.08); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.9);
    nsrc.connect(g); osc.connect(g); g.connect(ctx.destination); nsrc.start(); osc.start(); nsrc.stop(ctx.currentTime+0.9); osc.stop(ctx.currentTime+0.9);
  }catch(e){}
  setTimeout(()=>{ scare.style.display='none'; scare.classList.remove('scare-in'); res(); }, 1200); }); }
function confetti(){ const n=120, frag=document.createDocumentFragment();
  for(let i=0;i<n;i++){ const d=document.createElement('div'); const size=6+Math.random()*6;
    d.style.cssText=`position:fixed;left:${Math.random()*100}vw;top:-10px;width:${size}px;height:${size}px;background:hsl(${Math.random()*300+60}deg 90% 70%);opacity:.9;border-radius:2px;z-index:10`;
    frag.appendChild(d); const dur=1200+Math.random()*1200;
    d.animate([{transform:'translateY(0) rotate(0deg)'},{transform:'translate('+(Math.random()-.5)*60+'px,100vh) rotate('+ (Math.random()*720-360)+'deg)'}],
      {duration: dur,easing:'cubic-bezier(.2,.7,.2,1)',fill:'forwards'}).onfinish=()=>d.remove();
  } document.body.appendChild(frag); }

/* ====== ROUND 2: Willow’s Favor (self-running) ====== */
const el = {
  lvl2: document.getElementById('lvl2'),
  nameInp: document.getElementById('name'),
  saveName: document.getElementById('saveName'),
  total: document.getElementById('coinTotal'),
  manualToken: document.getElementById('manualToken'),
  scanMsg: document.getElementById('scanMsg'),
  showTrade: document.getElementById('showTrade'),
  recvTrade: document.getElementById('recvTrade'),
  tradeArea: document.getElementById('tradeArea'),
  whisperArea: document.getElementById('whisperArea')
};

// Printed token → effect mapping (matches your PDF)
const TOKEN_EFFECTS = {
  // Blessed +1
  'B1H3X9':'gain1','B2L2M4':'gain1','B3Q7K1':'gain1','B4N8P2':'gain1',
  // Golden +2
  'G2A7R5':'gain2','G2C1T8':'gain2',
  // Cursed −1
  'C1D9Z3':'lose1','C2F4Y6':'lose1','C3J2V8':'lose1','C4K5U1':'lose1',
  // Tangled −2
  'T2M8Q4':'lose2','T2R6N7':'lose2',
  // Doom wipe
  'D0O0M1':'wipe','D0O0M2':'wipe'
};

function r2State(){ const s=getState(); s.round2 = s.round2 || { coins: null, usedTokens:{} }; setState(s); return s.round2; }
function setR2(p){ const s=getState(); s.round2 = p; setState(s); }

function initRound2(){
  const s=getState(); const r = r2State();
  // start at 5 when round2 first appears
  if(r.coins==null){ r.coins = 5; setR2(r); }
  if(s.name){ /* optional use */ }
  el.total.textContent = r.coins;

  el.saveName.onclick=()=>{ const name=(el.nameInp.value||'').trim(); if(!name) return alert('Pick a codename first.'); const ss=getState(); ss.name=name; setState(ss); toast('Codename saved: @'+name); };
  el.manualToken.onclick=()=>{ const t = prompt('Enter the token printed on the sticker (e.g., B1H3X9):'); if(!t) return; applyToken(t.trim().toUpperCase()); };

  // auto-claim if URL has ?t=<token> or ?fx=...
  const p = new URLSearchParams(location.search);
  const token = p.get('t') || p.get('token');
  const fx = p.get('fx');
  if(token){ setTimeout(()=>applyToken(token.toUpperCase(), fx), 350); }

  // Trade
  el.showTrade.onclick=()=>startTradeSend();
  el.recvTrade.onclick=()=>startTradeReceive();

  // Willow’s Whisper every ~12 min
  scheduleWhisper();
  updateProgress();
}

function adjustCoins(delta, reason){
  const r = r2State();
  r.coins = Math.max(0, (r.coins||0) + delta);
  setR2(r);
  el.total.textContent = r.coins;
  el.scanMsg.textContent = `${delta>0?'+':'−'}${Math.abs(delta)} coin ${reason?`(${reason})`:''}`;
  el.scanMsg.style.color = delta>0 ? '#9ef0c9' : '#ff6b6b';
  // Ritual unlock check
  updateProgress();
  // If wiped badly, show loser’s curse modal
  if(r.coins===0 && document.getElementById('loser') && !document.getElementById('loser').open){
    document.getElementById('loser').showModal();
    document.getElementById('loserSubmit').onclick=()=>{
      const v=(document.getElementById('loserAns').value||'').trim().toLowerCase();
      if(v==='keyboard'){ adjustCoins(+1,'pity from Willow'); document.getElementById('loserMsg').textContent='Pity granted. +1 coin.'; }
      else { document.getElementById('loserMsg').textContent='Not it. (Hint: you are typing on one.)'; }
    };
  }
}

function applyToken(token, fxOverride){
  const r = r2State();
  if(r.usedTokens[token]){ toast('Already used on this device.'); return; }
  const fx = TOKEN_EFFECTS[token] || fxOverride;
  if(!fx){ toast('Unknown or invalid token.'); return; }
  r.usedTokens[token]=true; setR2(r);
  switch(fx){
    case 'gain1': adjustCoins(+1,'blessing'); break;
    case 'gain2': adjustCoins(+2,'golden boon'); break;
    case 'lose1': adjustCoins(-1,'curse'); break;
    case 'lose2': adjustCoins(-2,'tangled hex'); break;
    case 'wipe':  const lost = r.coins||0; r.coins=0; setR2(r); el.total.textContent=r.coins; toast(`Doom Mark! You lost ${lost} coin(s).`); updateProgress(); break;
    default: toast('Token had no effect.');
  }
}

function startTradeSend(){
  const r = r2State();
  if((r.coins||0) < 1) return toast('You need at least 1 coin to send.');
  const code = (''+Math.floor(1000+Math.random()*9000));
  el.tradeArea.innerHTML = `<p><b>Share this code:</b> <span style="color:#9ef0c9">${code}</span></p>
    <button id="confirmSend" class="pill">Confirm Transfer (−1)</button>`;
  document.getElementById('confirmSend').onclick=()=>{ adjustCoins(-1,'trade sent'); el.tradeArea.innerHTML='Sent. Tell them to claim it.'; };
  // This is honor-system; receiver separately enters code to gain +1.
}

function startTradeReceive(){
  const code = prompt('Enter the 4-digit code they showed you:'); 
  if(!code || !/^\d{4}$/.test(code)) return;
  adjustCoins(+1, 'trade received');
  el.tradeArea.textContent = 'Received +1.';
}

function scheduleWhisper(){
  const ms = 1000 * (60*10 + Math.floor(Math.random()*300)); // 10–15 minutes
  setTimeout(()=>{ showWhisper(); scheduleWhisper(); }, ms);
}
function showWhisper(){
  const choices = [
    {label:'Accept Boon (+1)', delta:+1, flair:'“Take what the wind gives.”'},
    {label:'Accept Hex (−1)', delta:-1, flair:'“Balance must be paid.”'},
    {label:'Decline', delta:0, flair:'The whisper fades.'}
  ];
  el.whisperArea.innerHTML = `<p><em>Willow’s Whisper:</em> “Favor or forfeit?”</p>` + 
    choices.map((c,i)=>`<button class="pill" data-whisper="${i}">${c.label}</button>`).join(' ') +
    `<p class="small" style="opacity:.8">Choose once; it vanishes.</p>`;
  el.whisperArea.querySelectorAll('[data-whisper]').forEach(b=>{
    b.onclick=()=>{ const i=+b.getAttribute('data-whisper'); const c=choices[i]; if(c.delta) adjustCoins(c.delta,'whisper'); el.whisperArea.innerHTML = `<p>${c.flair}</p>`; };
  });
}

function toast(msg){ const t=document.createElement('div'); t.textContent=msg;
  t.style.cssText='position:fixed;left:50%;top:14px;transform:translateX(-50%);background:#1a1530;color:#cfe9e0;border:1px solid #463a73;padding:8px 12px;border-radius:10px;z-index:99;box-shadow:0 8px 20px #0009';
  document.body.appendChild(t); setTimeout(()=>t.remove(), 1800);
}

/* ====== Boot ====== */
(function boot(){
  ensureId();
  const s=getState();
  // Restore header state
  for(let i=1;i<=5;i++){ if(s['s'+i]) coins[i-1].classList.add('got'); }
  initLvl1();
  if([1,2,3,4,5].every(i=>s['s'+i])){ document.getElementById('lvl2').classList.remove('hidden'); }
  // Initialize Round 2 state and process URL token (if any)
  initRound2();
})();
</script>
</body>
</html>
