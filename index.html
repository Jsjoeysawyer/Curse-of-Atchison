<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wicked Willow • Curse of Atchison (Solo)</title>
<meta name="theme-color" content="#111017">
<style>
  :root{ --bg:#0c0a12; --panel:#131022; --ink:#f0e6ff; --muted:#c8b8ffb3; --accent:#9ef0c9; --danger:#ff6b6b; --coin:#f6c945; --glow:#52ffb380; }
  *{box-sizing:border-box} html,body{height:100%}
  body{ margin:0; background: radial-gradient(1200px 700px at 70% -10%, #1b1533 0%, var(--bg) 45%, #09070f 100%); color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; line-height:1.55; overflow-x:hidden; }
  .stars{position:fixed; inset:0; pointer-events:none; z-index:0}
  .stars:before,.stars:after{content:""; position:absolute; inset:-50vh -50vw; background:
      radial-gradient(2px 2px at 10% 20%, #ffffff55 50%, transparent 60%),
      radial-gradient(2px 2px at 30% 80%, #ffffff33 50%, transparent 60%),
      radial-gradient(2px 2px at 70% 30%, #ffffff44 50%, transparent 60%),
      radial-gradient(2px 2px at 90% 60%, #ffffff22 50%, transparent 60%),
      radial-gradient(1.5px 1.5px at 50% 50%, #ffffff22 50%, transparent 60%);
      animation: drift 120s linear infinite; }
  .stars:after{animation-duration:160s; opacity:.6; filter:blur(.5px)}
  @keyframes drift{to{transform:translateY(40vh)}}
  header{ position:sticky; top:0; z-index:5; backdrop-filter: blur(8px); background:linear-gradient(180deg, #0f0c18dd, #0f0c18cc 60%, transparent); border-bottom:1px solid #30264a; box-shadow: 0 10px 30px #000d; }
  .wrap{max-width:940px; margin:0 auto; padding:16px}
  .title{display:flex; gap:12px; align-items:center; justify-content:space-between;}
  .brand{display:flex; gap:14px; align-items:center;}
  .sigil{ width:40px; height:40px; border-radius:50%; background: conic-gradient(from 210deg, #3efac4, #8bdcff, #b28bff, #3efac4); box-shadow: 0 0 16px var(--glow), inset 0 0 12px #0009; position:relative; }
  .sigil:after{content:"★"; position:absolute; inset:0; display:grid; place-items:center; color:#0a0a12; font-size:18px; text-shadow:0 0 10px #000;}
  h1{margin:0; font-weight:800; letter-spacing:.5px; font-size:20px}
  .progress{display:flex; align-items:center; gap:8px; margin-top:10px;}
  .bar{flex:1; height:10px; background:#1b1730; border-radius:99px; overflow:hidden; box-shadow: inset 0 0 0 1px #30264a;}
  .bar > i{display:block; height:100%; width:0%; background:linear-gradient(90deg, #48f8c5, #b693ff); box-shadow: 0 0 16px var(--glow) inset, 0 0 12px var(--glow)}
  .coins{display:flex; gap:6px}
  .coin{ width:22px; height:22px; border-radius:50%; background: radial-gradient(circle at 30% 30%, #fff8 0 20%, transparent 21%), linear-gradient(145deg, #ffeaa6, var(--coin));
         border:1px solid #e0b94a; box-shadow: inset 0 0 6px #966f00, 0 2px 4px #000a; transform:translateY(0); transition:transform .2s ease, filter .2s ease; filter:grayscale(100%) opacity(.4);}
  .coin.got{filter:none} .coin:hover{transform:translateY(-2px)}
  .actions{display:flex; gap:8px}
  button,.pill{ background:linear-gradient(180deg, #1d1733, #151029); border:1px solid #3c3161; color:var(--ink); padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:700; box-shadow: 0 6px 16px #0009, inset 0 0 0 1px #0006; }
  button:hover{border-color:#6e5bc6}
  .grid{display:grid; gap:16px; grid-template-columns:1fr; padding:20px 16px 56px;}
  @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
  .card{ background: linear-gradient(180deg, #17122b, #100c1d); border:1px solid #30264a; border-radius:16px; box-shadow: 0 20px 50px #000c, inset 0 0 0 1px #0008; position:relative; overflow:hidden;}
  .card .head{ padding:16px; display:flex; align-items:center; gap:10px; border-bottom:1px solid #2a2243; background: linear-gradient(180deg, #1a1433, transparent); }
  .tag{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #39465a; color:#a7c5c0; background: linear-gradient(180deg, #0f1e1a, #0b1412);}
  .card h2{margin:0; font-size:18px}
  .card .body{padding:16px; color:var(--muted)}
  .letter{background:#0e1520; border:1px dashed #3a4455; border-radius:12px; padding:12px; margin:10px 0; position:relative;}
  .letter:before{content:"Wax Seal"; position:absolute; right:-8px; top:-8px; font-size:10px; padding:6px 8px; border-radius:8px; background:linear-gradient(180deg, #2d243f, #1d1630); border:1px solid #4b3a77; color:#d9c8ff; box-shadow:0 6px 14px #0008; transform:rotate(6deg) }
  .letter .content{margin-top:10px; text-align:center; font-style:italic; line-height:1.6; color:#e8defa;}
  .riddle-input{display:flex; gap:8px; margin-top:12px;}
  .riddle-input input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid #393057; background:#0f0c18; color:#f0e6ff;}
  .result{margin-top:8px; font-weight:700} .ok{color: var(--accent)} .no{color: var(--danger)}
  .hint{font-size:12px; color:#9db2a9}
  .footer{position:sticky; bottom:0; z-index:4; border-top:1px solid #2b2341; background:linear-gradient(0deg, #0f0c18dd, #0f0c18cc 60%, transparent);}
  .ritual{display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px 16px;}
  .ritual .status{font-weight:800; letter-spacing:.3px}
  #spellPane{display:none} #spellPane.open{display:block}
  .ritual .spell{background:#0f1522; border:1px solid #344; border-radius:12px; padding:12px; color:#cfe9e0;}

  dialog{ border:none; border-radius:16px; background:#140f24; color:var(--ink); max-width:640px; width:calc(100% - 28px);
          padding:0; box-shadow: 0 40px 120px #000f, inset 0 0 0 1px #2d2450; }
  dialog::backdrop{background:#0009}
  .modal-head{display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid #2d2450; background:#1a1530}
  .modal-body{padding:16px; color:var(--muted)}
  .x{background:transparent; border:1px solid #463a73; border-radius:10px; padding:6px 10px; color:#ddd; cursor:pointer}
  .hidden{display:none !important} .small{font-size:12px} .sep{height:1px; background:#2a2243; margin:12px 0}

  /* Jump scares */
  #scare, #scareBad { position:fixed; inset:0; background:#000; display:none; z-index:9999; align-items:center; justify-content:center; }
  #scare .flash, #scareBad .flash { position:absolute; inset:0; background:radial-gradient(circle at 50% 50%, #ffffff, #ffd2d2 40%, #000 70%); opacity:0; }
  #scare .face, #scareBad .face { width:min(90vw,700px); height:auto; opacity:0; filter:drop-shadow(0 0 20px #000);
    background-repeat:no-repeat; background-position:center; background-size:contain; }
  #scare .face{ background-image:url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 700 700"><rect width="700" height="700" fill="black"/><g fill="white"><ellipse cx="240" cy="260" rx="70" ry="95"/><ellipse cx="460" cy="260" rx="70" ry="95"/><path d="M210 480 Q350 620 490 480 Q350 520 210 480 Z" /></g><g fill="black"><ellipse cx="240" cy="270" rx="28" ry="38"/><ellipse cx="460" cy="270" rx="28" ry="38"/></g></svg>'); }
  #scareBad .face{ background-image:url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 700 700"><rect width="700" height="700" fill="black"/><g fill="red"><ellipse cx="240" cy="260" rx="80" ry="110"/><ellipse cx="460" cy="260" rx="80" ry="110"/><path d="M140 520 Q350 420 560 520 Q350 580 140 520 Z" /></g><g fill="black"><ellipse cx="240" cy="270" rx="20" ry="30"/><ellipse cx="460" cy="270" rx="20" ry="30"/></g></svg>'); }
  .scare-in .flash{animation: flash 0.25s ease forwards} .scare-in .face{animation: popIn 0.28s ease forwards 0.05s}
  @keyframes popIn { from { transform:scale(0.65); opacity:0; } to { transform:scale(1); opacity:1; } }
  @keyframes flash { 0%{opacity:0} 40%{opacity:1} 100%{opacity:0.2} }
</style>
</head>
<body>
<div class="stars"></div>

<header>
  <div class="wrap">
    <div class="title">
      <div class="brand">
        <div class="sigil" aria-hidden="true"></div>
        <div>
          <h1>Wicked Willow · Curse of Atchison</h1>
          <div class="progress"><div class="bar"><i id="barFill" style="width:0%"></i></div>
            <div class="coins"><div class="coin" id="c1"></div><div class="coin" id="c2"></div><div class="coin" id="c3"></div><div class="coin" id="c4"></div><div class="coin" id="c5"></div></div>
          </div>
        </div>
      </div>
      <div class="actions">
        <button id="hintToggle" class="pill" aria-expanded="false">Hints: Off</button>
        <button id="reset" class="pill" title="Reset your progress">Reset</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <p class="small" style="color:var(--muted)">Solve the lore riddles to mint 5 coins → <b>Solo Round 2</b> (30-minute hunt with fate & one trade) → Win = lift the curse; Lose = the curse follows you home.</p>

  <div class="grid" id="grid">
    <!-- SECTION 1 -->
    <section class="card" id="s1"><div class="head"><span class="tag">1 · The Ridge</span><h2>Ashes & Echoes</h2></div>
      <div class="body">
        <p>Willow lit a broken lantern and spoke to the wind the night the mine collapsed.</p>
        <div class="letter"><strong>Lantern Note</strong><div class="content"><p>“Truth warned you, but greed made you deaf. If light returns to the lantern, the path might yet be seen.”</p></div></div>
        <p><strong>Riddle:</strong> I eat what I’m fed, yet I perish if I drink; I dance when I’m hungry and leave only char and stink. What am I?</p>
        <div class="riddle-input"><input id="a1" placeholder="Type your answer…"/><button data-check="1">Submit</button></div><div id="r1" class="result"></div>
        <p class="hint hidden" id="h1">Hint: Lanterns are its cradle; rain is its grave.</p>
      </div>
    </section>

    <!-- SECTION 2 -->
    <section class="card" id="s2"><div class="head"><span class="tag">2 · Mine Mouth</span><h2>The Warning</h2></div>
      <div class="body">
        <div class="letter"><strong>Miner’s Pocket Letter</strong><div class="content"><p>“If the song stops, turn back. No vein of coal is worth a widow’s veil.”</p></div></div>
        <p><strong>Riddle:</strong> I save you by surrendering breath, a sentinel whose voice foretells death. What am I?</p>
        <div class="riddle-input"><input id="a2" placeholder="Type your answer…"/><button data-check="2">Submit</button></div><div id="r2" class="result"></div>
        <p class="hint hidden" id="h2">Hint: A tiny singer in a cage.</p>
      </div>
    </section>

    <!-- SECTION 3 -->
    <section class="card" id="s3"><div class="head"><span class="tag">3 · The Dry River</span><h2>Salt & Bones</h2></div>
      <div class="body">
        <div class="letter"><strong>River-Binding Spell</strong><div class="content"><p>“Break my course and still my tongue; leave only salt upon my lungs.”</p></div></div>
        <p><strong>Riddle:</strong> With banks but no vault, a mouth without teeth, I flee to the ocean yet never grow feet. What am I?</p>
        <div class="riddle-input"><input id="a3" placeholder="Type your answer…"/><button data-check="3">Submit</button></div><div id="r3" class="result"></div>
        <p class="hint hidden" id="h3">Hint: Its bed is not for sleeping.</p>
      </div>
    </section>

    <!-- SECTION 4 -->
    <section class="card" id="s4"><div class="head"><span class="tag">4 · The Cottage</span><h2>The Mayor’s Head</h2></div>
      <div class="body">
        <div class="letter"><strong>Whisper from the Box</strong><div class="content"><p>“Heh… look what she left me—only weight on my words.”</p></div></div>
        <p><strong>Riddle:</strong> Read me forward and I burden you; read me backward and I bother you not. What am I?</p>
        <div class="riddle-input"><input id="a4" placeholder="Type your answer…"/><button data-check="4">Submit</button></div><div id="r4" class="result"></div>
        <p class="hint hidden" id="h4">Hint: A three-letter unit.</p>
      </div>
    </section>

    <!-- SECTION 5 -->
    <section class="card" id="s5"><div class="head"><span class="tag">5 · Town Square</span><h2>The Accusation</h2></div>
      <div class="body">
        <div class="letter"><strong>Willow’s Poem (Acrostic)</strong><div class="content">
          <p><span style="color:#9ef0c9;font-weight:bold">T</span>he hills remember what the town forgot.</p>
          <p><span style="color:#9ef0c9;font-weight:bold">R</span>estore the lantern; let blame burn out.</p>
          <p><span style="color:#9ef0c9;font-weight:bold">U</span>ndo the oath of anger with a single word.</p>
          <p><span style="color:#9ef0c9;font-weight:bold">C</span>ease your shouting; let silence mend.</p>
          <p><span style="color:#9ef0c9;font-weight:bold">E</span>nd what began in fear—begin again in truth.</p>
        </div></div>
        <p><strong>Question:</strong> Read the acrostic. Enter the single word to end the curse.</p>
        <div class="riddle-input"><input id="a5" placeholder="Type the one word…"/><button data-check="5">Submit</button></div><div id="r5" class="result"></div>
        <p class="hint hidden" id="h5">Hint: Take the first letter of each line.</p>
      </div>
    </section>

    <!-- SOLO ROUND 2 -->
    <section class="card hidden" id="lvl2"><div class="head"><span class="tag">Round 2</span><h2>Solo Hunt — “The Curse Follows or Fades”</h2></div>
      <div class="body">
        <div class="letter"><strong>How to Play</strong><div class="content">
          <p>You have <b>30 minutes</b> to find <b>all posted QR sigils</b>. Each scan reveals a message and fate: <b>+2 coins</b>, <b>−1 coin</b>, or <b>DOOM</b> (instant loss). You may perform <b>one</b> trade during the run.</p>
          <p><button id="startSolo" class="pill">Start My 30-Minute Run</button> <span id="timer" class="small">Not started</span></p>
          <p class="small" style="opacity:.8">Tip: Use your one trade wisely—give or receive only once.</p>
        </div></div>

        <div class="letter"><strong>My Status</strong><div class="content">
          <p>Codename: <input id="name" placeholder="e.g., LanternFox" style="width:60%;padding:6px;border-radius:8px;border:1px solid #393057;background:#0f0c18;color:#f0e6ff"> <button id="saveName" class="pill">Save</button></p>
          <p>Round-2 Coins: <b><span id="points">0</span></b> · Checkpoints found: <b><span id="foundCount">0</span>/<span id="totalCount">0</span></b> · Trade used: <b><span id="tradeUsed">No</span></b></p>
        </div></div>

        <div class="letter"><strong>Use My One Trade</strong><div class="content">
          <p><button id="useTrade" class="pill">Use Trade Now</button></p>
          <p class="small">In person: agree with someone to <i>give</i> or <i>receive</i> 1 coin. This can be used only once per run.</p>
        </div></div>

        <div class="letter"><strong>Scan or Enter Token</strong><div class="content">
          <p><button id="scanBtn" class="pill">Scan with Camera</button> <button id="qrClaimBtn" class="pill">Enter Token</button></p>
          <p class="small" style="opacity:.8">If scanning fails on your device, use <b>Enter Token</b>.</p>
        </div></div>
      </div>
    </section>
  </div>
</main>

<!-- Ritual / Outcomes -->
<footer class="footer">
  <div class="wrap ritual" id="ritual">
    <div>
      <div class="status" id="ritualStatus">Ritual Locked — collect 5 coins to unlock Solo Round 2.</div>
      <div class="small" style="color:var(--muted)">Round 2 starts when you tap “Start My 30-Minute Run”.</div>
    </div>
    <div><button class="cast" id="castBtn" disabled>Perform Final Ritual</button></div>
  </div>
  <div class="wrap ritual spell" id="spellPane">
    <div class="sep"></div>
    <div class="spell">
      <p><strong>Final Rite of Unbinding</strong></p>
      <p style="color:#cfe9e0"><em>“Lantern rekindled, river released; song restored, and judgment ceased.<br>From ridge to square, let grudges part—<br>Return what’s owed and mend the heart.”</em></p>
      <p class="small">If you won your solo run, tap below.</p>
      <button id="lift" class="pill">Lift the Curse</button>
    </div>
  </div>
</footer>

<!-- Jump Scares -->
<div id="scare" aria-hidden="true"><div class="flash"></div><div class="face" role="img" aria-label="Wicked Willow appears"></div></div>
<div id="scareBad" aria-hidden="true"><div class="flash"></div><div class="face" role="img" aria-label="The curse follows you home"></div></div>

<!-- Prize -->
<dialog id="prize">
  <div class="modal-head">
    <strong>✨ The Curse Lifts!</strong>
    <button class="x" data-close="prize" aria-label="Close">Close</button>
  </div>
  <div class="modal-body">
    <p>The wind softens, the river stirs, and the Mayor’s whisper fades at last.</p>
    <p><strong>Prize:</strong> Show this to the host for your reward.</p>
  </div>
</dialog>

<!-- Messages -->
<dialog id="msg">
  <div class="modal-head">
    <strong id="msgTitle">Message</strong>
    <button class="x" data-close="msg" aria-label="Close">Close</button>
  </div>
  <div class="modal-body" id="msgBody"></div>
</dialog>

<!-- Camera Scanner -->
<dialog id="scanDlg">
  <div class="modal-head">
    <strong>Scan QR</strong>
    <button class="x" data-close="scanDlg" aria-label="Close">Close</button>
  </div>
  <div class="modal-body">
    <div class="small" id="scanStatus" style="margin-bottom:8px">Initializing camera…</div>
    <video id="scanVideo" playsinline style="width:100%;border-radius:12px;background:#000;max-height:60vh"></video>
    <div style="display:flex;gap:8px;margin-top:10px;">
      <button id="scanTorch" class="pill">Toggle Torch</button>
      <button id="scanStop" class="pill">Stop</button>
    </div>
    <div class="small" style="opacity:.8;margin-top:8px">
      If scanning fails on your device, close this and use <b>Enter Token</b>.
    </div>
  </div>
</dialog>

<script>
/* ====== Level 1 (Riddles) ====== */
const LVL1_ANS = {1:'fire',2:'canary',3:'river',4:'ton',5:'truce'};
const coins=[...document.querySelectorAll('.coin')];
const bar=document.getElementById('barFill');
const castBtn=document.getElementById('castBtn');
const ritualStatus=document.getElementById('ritualStatus');
const spellPane=document.getElementById('spellPane');
const scare=document.getElementById('scare');
const scareBad=document.getElementById('scareBad');

const ids=['a1','a2','a3','a4','a5'], rs=['r1','r2','r3','r4','r5'], hs=['h1','h2','h3','h4','h5'];
const inputs=ids.map(id=>document.getElementById(id));
const results=rs.map(id=>document.getElementById(id));
const hints=hs.map(id=>document.getElementById(id));

document.getElementById('hintToggle').onclick=()=>toggleHints();
document.getElementById('reset').onclick=()=>{ if(confirm('Reset ALL progress?')){ localStorage.clear(); location.reload(); } };

document.addEventListener('click', (e)=>{
  const btn=e.target.closest('[data-close]');
  if(btn){
    const id=btn.getAttribute('data-close');
    const dlg=document.getElementById(id);
    if(dlg && dlg.close) dlg.close();
  }
});

function getState(){ try{return JSON.parse(localStorage.getItem('willow_qr')||'{}')}catch{return{}} }
function setState(s){ localStorage.setItem('willow_qr', JSON.stringify(s)); }
function ensureId(){ const s=getState(); if(!s.id){ s.id=crypto.randomUUID(); setState(s);} return s.id; }

function initLvl1(){
  const s=getState();
  for(let i=1;i<=5;i++){ if(s['s'+i]) award(i,false); }
  updateProgress();
  ids.forEach((id,idx)=>{
    const btn=document.querySelector(`button[data-check="${idx+1}"]`);
    btn.onclick=()=>check(idx+1);
    inputs[idx].addEventListener('keydown',e=>{ if(e.key==='Enter') check(idx+1); });
  });
  castBtn.onclick=()=>{ if(!castBtn.disabled){ openRitual(); } };
  document.getElementById('lift').onclick=async()=>{
    await jumpScareWin();
    const dlg=document.getElementById('prize'); if(dlg && dlg.showModal) dlg.showModal();
    confetti();
  };
}
function check(i){
  const val=(inputs[i-1].value||'').trim().toLowerCase();
  if(val===LVL1_ANS[i]){ results[i-1].textContent='Correct. Coin minted! ✨'; results[i-1].className='result ok'; award(i,true); updateProgress(); }
  else { results[i-1].textContent='Not quite. Try again.'; results[i-1].className='result no'; }
}
function award(i,animate){
  const s=getState(); if(!s['s'+i]){ s['s'+i]=true; setState(s); }
  coins[i-1].classList.add('got');
  if(animate) coins[i-1].animate([{transform:'scale(1)'},{transform:'scale(1.3)'},{transform:'scale(1)'}],{duration:550});
}
function updateProgress(){
  const s=getState(); const count=[1,2,3,4,5].filter(k=>s['s'+k]).length; bar.style.width=(count/5*100)+'%';
  if(count===5){
    document.getElementById('lvl2').classList.remove('hidden');
    ritualStatus.textContent = 'Solo Round 2 unlocked. Start your 30-minute run when ready.';
    castBtn.disabled = true; // final ritual appears only after a solo WIN
  }else{
    ritualStatus.textContent = `Ritual Locked — ${5-count} coin(s) remaining.`;
    castBtn.disabled = true;
  }
}
function openRitual(){
  spellPane.classList.add('open');
  document.getElementById('ritual').scrollIntoView({behavior:'smooth', block:'start'});
}
function toggleHints(){ const on=document.getElementById('hintToggle').getAttribute('aria-expanded')==='true';
  document.getElementById('hintToggle').setAttribute('aria-expanded', String(!on)); document.getElementById('hintToggle').textContent='Hints: '+(!on?'On':'Off');
  hints.forEach(h=>h.classList.toggle('hidden', on));
}

/* ====== Jump scares + confetti ====== */
function jumpScareWin(){ return new Promise(res=>{ scare.style.display='flex'; scare.classList.add('scare-in'); sfx(380,40,0.9); setTimeout(()=>{ scare.style.display='none'; scare.classList.remove('scare-in'); res(); }, 1200); }); }
function jumpScareCurse(){ return new Promise(res=>{ scareBad.style.display='flex'; scareBad.classList.add('scare-in'); sfx(120,20,1.4,true); setTimeout(()=>{ scareBad.style.display='none'; scareBad.classList.remove('scare-in'); res(); }, 1600); }); }
function sfx(startHz, endHz, dur, noise=false){
  try{ const C=window.AudioContext||window.webkitAudioContext; const ctx=new C();
    const osc=ctx.createOscillator(); osc.type='sawtooth'; osc.frequency.setValueAtTime(startHz, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(endHz, ctx.currentTime+0.4);
    const g=ctx.createGain(); g.gain.setValueAtTime(0.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.9, ctx.currentTime+0.08); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
    osc.connect(g); g.connect(ctx.destination);
    if(noise){ const n=ctx.createBuffer(1, 2*ctx.sampleRate, ctx.sampleRate); const ch=n.getChannelData(0); for(let i=0;i<ch.length;i++) ch[i]=(Math.random()*2-1)*(1-i/ch.length); const ns=ctx.createBufferSource(); ns.buffer=n; ns.connect(g); ns.start(); ns.stop(ctx.currentTime+dur); }
    osc.start(); osc.stop(ctx.currentTime+dur);
  }catch(e){}
}
function confetti(){ const n=120, frag=document.createDocumentFragment();
  for(let i=0;i<n;i++){ const d=document.createElement('div'); const size=6+Math.random()*6;
    d.style.cssText=`position:fixed;left:${Math.random()*100}vw;top:-10px;width:${size}px;height:${size}px;background:hsl(${Math.random()*300+60}deg 90% 70%);opacity:.9;border-radius:2px;z-index:10`;
    frag.appendChild(d); const dur=1200+Math.random()*1200;
    d.animate([{transform:'translateY(0) rotate(0deg)'},{transform:'translate('+(Math.random()-.5)*60+'px,100vh) rotate('+ (Math.random()*720-360)+'deg)'}],
      {duration: dur,easing:'cubic-bezier(.2,.7,.2,1)',fill:'forwards'}).onfinish=()=>d.remove();
  } document.body.appendChild(frag); }

/* ====== SOLO ROUND 2 ====== */
/* SETTINGS — tweak if you like */
const TIME_LIMIT_MIN = 30;                 // minutes per solo run
const FATE = { gain:0.55, lose:0.30, doom:0.15 }; // odds per scan
const COIN_CHANGE = { gain:+2, lose:-1 };          // coin deltas
// Tokens for your posted QR codes (EDIT these to match your printed stickers)
const QR_TOKENS = {
  // Example set — replace with yours (token:"Label")
  'HBTRQJ':'Saloon','GF5CBF':'Hotel','PQBN4Q':'Jail','6TAL5X':'Blacksmith',
  'TKPXGF':'Church','2GYYSC':'Water Tower','7H2FUZ':'Train Tracks','NECQUF':'General Store',
  'QG2T7Z':'Undertaker','LZYPTE':'Schoolhouse','LRL72T':'Barn','QWDQCW':'Windmill'
};
/* ====== end settings ====== */

const els = {
  lvl2: document.getElementById('lvl2'),
  nameInp: document.getElementById('name'),
  saveName: document.getElementById('saveName'),
  points: document.getElementById('points'),
  foundCount: document.getElementById('foundCount'),
  totalCount: document.getElementById('totalCount'),
  tradeUsed: document.getElementById('tradeUsed'),
  startSolo: document.getElementById('startSolo'),
  timer: document.getElementById('timer'),
  qrBtn: document.getElementById('qrClaimBtn'),
  useTrade: document.getElementById('useTrade'),
};

const MSGS_WILLOW = [
  "“You blamed me for the dark—yet you dug the tunnel.”",
  "“Set down your fear and the dust will settle.”",
  "“Truth is a lantern: it burns, but it shows the way.”",
  "“Trade kindly; Atchison remembers debts.”"
];
const MSGS_DEAD = [
  "The canary fell silent… and so did we.",
  "We drown in dust, not water.",
  "Our bones line the riverbed of your choices.",
  "We whisper: let blame go, or be buried with it."
];

let soloClock=null;

function initSolo(){
  els.totalCount.textContent = Object.keys(QR_TOKENS).length;
  els.saveName.onclick=()=>{
    const name=(els.nameInp.value||'').trim();
    if(!name) return alert('Pick a codename first.');
    const s=getState(); s.name=name; setState(s);
    alert('Codename saved.');
  };
  els.startSolo.onclick=startRun;
  els.qrBtn.onclick=manualToken;
  els.useTrade.onclick=doTrade;

  // Auto-handle ?token on load (scan via external camera app)
  const p=new URLSearchParams(window.location.search);
  const t=p.get('token')||p.get('claimToken');
  if(t){ setTimeout(()=>resolveToken(t), 400); }

  // Restore state UI
  const s=getState();
  if(s.r2){
    els.points.textContent=s.r2.points||0;
    els.foundCount.textContent = Object.keys(s.r2.found||{}).length;
    els.tradeUsed.textContent = s.r2.tradeUsed?'Yes':'No';
    updateTimerLabel();
    if(s.r2.startedAt && !s.r2.over) tickTimer();
  }

  // Wire camera scanner
  initScanner();
}
function startRun(){
  const s=getState();
  if(s.r2 && s.r2.startedAt && !s.r2.over){
    return alert('Your run is already in progress. Good luck!');
  }
  const now=Date.now();
  s.r2={ startedAt: now, endsAt: now + TIME_LIMIT_MIN*60000, points:0, doom:false, found:{}, tradeUsed:false, over:false, win:false };
  setState(s);
  updateTimerLabel();
  tickTimer();
  alert('The lantern burns. Your hunt begins!');
}
function manualToken(){
  const t=prompt('Enter the token printed on the QR sticker:');
  if(t) resolveToken(t);
}
function doTrade(){
  const s=getState();
  if(!s.r2 || s.r2.over || s.r2.doom) return alert('You must be in an active run to trade.');
  if(s.r2.tradeUsed) return alert('Trade already used this run.');
  const dir=prompt('Type "give" to give 1 coin, or "receive" to take 1 coin from a partner (honor system).')?.toLowerCase();
  if(dir!=='give' && dir!=='receive') return;
  if(dir==='give') s.r2.points=Math.max(0,(s.r2.points||0)-1);
  if(dir==='receive') s.r2.points=(s.r2.points||0)+1;
  s.r2.tradeUsed=true; setState(s);
  els.tradeUsed.textContent='Yes'; els.points.textContent=s.r2.points;
  alert('Trade complete.');
}

function updateTimerLabel(){
  const s=getState();
  if(!s.r2 || !s.r2.startedAt){ els.timer.textContent='Not started'; return; }
  const diff=(s.r2.endsAt - Date.now());
  if(diff<=0){ els.timer.textContent='00:00'; return; }
  const m=Math.floor(diff/60000), sec=Math.floor((diff%60000)/1000);
  els.timer.textContent=`${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}
function tickTimer(){
  if(soloClock) clearInterval(soloClock);
  soloClock = setInterval(()=>{
    const s=getState();
    if(!s.r2 || s.r2.over) return clearInterval(soloClock);
    const now=Date.now();
    if(now >= s.r2.endsAt){
      s.r2.over=true; setState(s);
      checkOutcome();
      clearInterval(soloClock);
    }
    updateTimerLabel();
  }, 1000);
}

function resolveToken(raw){
  const t=(String(raw||'')).trim().toUpperCase();
  const label = QR_TOKENS[t];
  if(!label){ alert('That token is not recognized.'); return; }
  const s=getState();
  if(!s.r2 || !s.r2.startedAt || s.r2.over){ return alert('Start your 30-minute run first.'); }
  if(s.r2.doom){ return alert('Your fate is already sealed. The curse follows you.'); }
  if(s.r2.found && s.r2.found[t]){ return alert('You already claimed this sigil.'); }

  // Roll fate
  const fate = rollFate();
  s.r2.found = s.r2.found || {};
  s.r2.found[t] = fate;

  if(fate==='gain'){ s.r2.points=(s.r2.points||0)+COIN_CHANGE.gain; showMsg('Willow Speaks', pick(MSGS_WILLOW) + `<br><br><b>Fate:</b> +${COIN_CHANGE.gain} coins`); }
  if(fate==='lose'){ s.r2.points=Math.max(0,(s.r2.points||0)+COIN_CHANGE.lose); showMsg('A Voice from the Shaft', pick(MSGS_DEAD) + `<br><br><b>Fate:</b> ${COIN_CHANGE.lose} coin`); }
  if(fate==='doom'){ s.r2.doom=true; s.r2.over=true; setState(s); els.foundCount.textContent = Object.keys(s.r2.found).length; loseFlow('A Cold Hand', pick(MSGS_DEAD) + "<br><br><b>Fate:</b> <span style='color:#ff6b6b'>DOOM</span>"); return; }

  setState(s);
  els.points.textContent=s.r2.points;
  els.foundCount.textContent = Object.keys(s.r2.found).length;

  // Found all before time, not doomed => WIN
  if(Object.keys(s.r2.found).length === Object.keys(QR_TOKENS).length){
    s.r2.over=true; s.r2.win=true; setState(s); winFlow();
  }
}
function rollFate(){
  const r=Math.random();
  if(r < FATE.gain) return 'gain';
  if(r < FATE.gain + FATE.lose) return 'lose';
  return 'doom';
}
function showMsg(title, html){
  const dlg=document.getElementById('msg');
  document.getElementById('msgTitle').textContent=title;
  document.getElementById('msgBody').innerHTML=html;
  if(dlg && dlg.showModal) dlg.showModal();
}
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function checkOutcome(){
  const s=getState(); if(!s.r2) return;
  if(s.r2.doom){ loseFlow('Your Footsteps Echo', 'The lantern goes dark. The curse finds your doorstep.'); return; }
  if(Object.keys(s.r2.found||{}).length !== Object.keys(QR_TOKENS).length){
    loseFlow('Too Late', 'Midnight passes; the gulch exhales. The curse follows you home.');
  }else{
    winFlow();
  }
}
async function winFlow(){
  castBtn.disabled=false; openRitual();
  await jumpScareWin(); confetti();
}
async function loseFlow(title, html){
  showMsg(title, html);
  await jumpScareCurse();
  alert('☠️ You lost your run. Try again later… the curse lingers.');
}

/* ====== Camera QR Scanner (BarcodeDetector) ====== */
const scanDlg   = document.getElementById('scanDlg');
const scanVideo = document.getElementById('scanVideo');
const scanStatus= document.getElementById('scanStatus');
const scanTorch = document.getElementById('scanTorch');
const scanStop  = document.getElementById('scanStop');
const scanBtn   = document.getElementById('scanBtn');

let scanStream = null, scanLoopId = null, barcodeDetector = null, torchOn = false, torchTrack = null;

function initScanner(){
  if(!scanBtn) return;
  scanBtn.addEventListener('click', async ()=>{
    if(!('BarcodeDetector' in window)){
      alert('This browser does not support camera scanning. Use Enter Token instead.');
      return;
    }
    try{
      const formats = ['qr_code','aztec','data_matrix','pdf417'];
      barcodeDetector = new window.BarcodeDetector({formats});
    }catch(e){
      barcodeDetector = new window.BarcodeDetector();
    }
    if(scanDlg && scanDlg.showModal) scanDlg.showModal();
    scanStatus.textContent='Requesting camera…';
    try{
      scanStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720}}, audio:false });
      scanVideo.srcObject = scanStream; await scanVideo.play();
      scanStatus.textContent='Point camera at a QR code.';
      torchTrack = (scanStream.getVideoTracks && scanStream.getVideoTracks()[0]) || null;
      if(!torchTrack || !torchTrack.getCapabilities || !torchTrack.getCapabilities().torch){ scanTorch.disabled=true; } else { scanTorch.disabled=false; }
      startScanLoop();
    }catch(err){ scanStatus.textContent='Camera permission denied or unavailable.'; }
  });
  scanTorch?.addEventListener('click', async ()=>{
    if(!torchTrack || !torchTrack.applyConstraints) return;
    try{ torchOn = !torchOn; await torchTrack.applyConstraints({ advanced:[{torch:torchOn}] }); }catch(e){ scanTorch.disabled=true; }
  });
  scanStop?.addEventListener('click', stopScanner);
  document.addEventListener('click', (e)=>{ const btn=e.target.closest('[data-close="scanDlg"]'); if(btn) stopScanner(); });
}
function startScanLoop(){
  const tick = async ()=>{
    if(!barcodeDetector || scanVideo.readyState < 2){ scanLoopId = requestAnimationFrame(tick); return; }
    try{
      const codes = await barcodeDetector.detect(scanVideo);
      if(codes && codes.length){
        const raw = (codes[0].rawValue || '').trim();
        let token = '';
        try{ const u=new URL(raw); token = u.searchParams.get('token') || u.searchParams.get('claimToken') || ''; }
        catch{ token = raw; }
        token = (token || raw || '').trim();
        if(token){
          stopScanner();
          setTimeout(()=>resolveToken(token), 150);
          return;
        }
      }
    }catch(e){}
    scanLoopId = requestAnimationFrame(tick);
  };
  scanLoopId = requestAnimationFrame(tick);
}
function stopScanner(){
  if(scanLoopId){ cancelAnimationFrame(scanLoopId); scanLoopId=null; }
  try{
    if(torchTrack && torchOn){ torchTrack.applyConstraints({ advanced:[{torch:false}] }).catch(()=>{}); torchOn=false; }
  }catch(e){}
  if(scanStream){ scanStream.getTracks().forEach(t=>t.stop()); scanStream=null; }
  if(scanDlg && scanDlg.open) scanDlg.close();
}

/* ====== Boot ====== */
(function boot(){
  ensureId();
  initLvl1();
  initSolo();
})();
</script>
</body>
</html>
