<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Curse of Atchison · Round 2 (Code Hunt)</title>
<meta name="theme-color" content="#111017">
<style>
  :root{ --bg:#0c0a12; --card:#141022; --ink:#f0e6ff; --muted:#c9c0e6; --ok:#95f5c9; --no:#ff6b6b; --accent:#a487ff; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; background:radial-gradient(900px 600px at 70% -10%, #201a39 0%, #0c0a12 50%, #08070e 100%); color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; line-height:1.55;}
  header{padding:16px; border-bottom:1px solid #2b2441; position:sticky; top:0; background:#0f0c18cc; backdrop-filter:blur(8px)}
  .wrap{max-width:880px; margin:0 auto; padding:0 12px}
  h1{margin:0; font-size:22px}
  .card{background:var(--card); border:1px solid #2a2243; border-radius:14px; padding:14px; margin:14px 0}
  .btn{display:inline-block; padding:10px 14px; border-radius:12px; border:1px solid #3d3264; background:linear-gradient(180deg,#1a1430,#120d22); color:#fff; font-weight:700; cursor:pointer}
  .btn[disabled]{opacity:.45; cursor:not-allowed}
  .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  .small{font-size:12px; color:#bfc6e6}
  a.btn { text-decoration:none }
  input[type="text"]{ padding:10px; border-radius:10px; border:1px solid #3a315d; background:#0f0c18; color:#f0e6ff; min-width:220px }
  blockquote{margin:8px 0; padding-left:12px; border-left:3px solid #3d3264; color:#d7cff3}

  /* Clue grid */
  .clues{display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px}
  .clue{background:#0f0c18; border:1px dashed #3a315d; border-radius:12px; padding:10px; text-align:center; color:#cfd6ff}
  .clue .n{font-weight:800; font-size:22px; color:#a0f0cc}
  .clue.s{border-style:solid; border-color:#3c6; color:#aaf0c9}
  .clue.d{border-style:solid; border-color:#f66; color:#ffb0b0}

  /* Modals */
  dialog{ border:none; border-radius:16px; background:#140f24; color:var(--ink); max-width:720px; width:calc(100% - 28px);
          padding:0; box-shadow: 0 40px 120px #000f, inset 0 0 0 1px #2d2450; }
  dialog::backdrop{background:#0009}
  .modal-head{display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid #2d2450; background:#1a1530}
  .modal-body{padding:16px; color:var(--muted)}
  .x{background:transparent; border:1px solid #463a73; border-radius:10px; padding:6px 10px; color:#ddd; cursor:pointer}

  /* Jump scares */
  #scare, #scareBad { position:fixed; inset:0; background:#000; display:none; z-index:9999; align-items:center; justify-content:center; }
  #scare .flash, #scareBad .flash { position:absolute; inset:0; background:radial-gradient(circle at 50% 50%, #ffffff, #ffd2d2 40%, #000 70%); opacity:0; }
  #scare .face, #scareBad .face { width:min(90vw,700px); height:auto; opacity:0; filter:drop-shadow(0 0 20px #000);
    background-repeat:no-repeat; background-position:center; background-size:contain; }
  #scare .face{ background-image:url('data:image/svg+xml;utf8,\
<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 700 700\"><rect width=\"700\" height=\"700\" fill=\"black\"/><g fill=\"white\"><ellipse cx=\"240\" cy=\"260\" rx=\"70\" ry=\"95\"/><ellipse cx=\"460\" cy=\"260\" rx=\"70\" ry=\"95\"/><path d=\"M210 480 Q350 620 490 480 Q350 520 210 480 Z\" /></g><g fill=\"black\"><ellipse cx=\"240\" cy=\"270\" rx=\"28\" ry=\"38\"/><ellipse cx=\"460\" cy=\"270\" rx=\"28\" ry=\"38\"/></g></svg>'); }
  #scareBad .face{ background-image:url('data:image/svg+xml;utf8,\
<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 700 700\"><rect width=\"700\" height=\"700\" fill=\"black\"/><g fill=\"red\"><ellipse cx=\"240\" cy=\"260\" rx=\"80\" ry=\"110\"/><ellipse cx=\"460\" cy=\"260\" rx=\"80\" ry=\"110\"/><path d=\"M140 520 Q350 420 560 520 Q350 580 140 520 Z\" /></g><g fill=\"black\"><ellipse cx=\"240\" cy=\"270\" rx=\"20\" ry=\"30\"/><ellipse cx=\"460\" cy=\"270\" rx=\"20\" ry=\"30\"/></g></svg>'); }
  .scare-in .flash{animation: flash 0.25s ease forwards} .scare-in .face{animation: popIn 0.28s ease forwards 0.05s}
  @keyframes popIn { from { transform:scale(0.65); opacity:0; } to { transform:scale(1); opacity:1; } }
  @keyframes flash { 0%{opacity:0} 40%{opacity:1} 100%{opacity:0.2} }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Round 2 · Code Hunt</h1>
    <div class="small">Find <b>10 hidden codes</b> around the party. Enter each code below. Every claim reveals a message and fate: <b>+2</b>, <b>−1</b>, or <b>DOOM</b>. One trade allowed. <b>Auto-win at 10 coins.</b></div>
  </div>
</header>

<main class="wrap">
  <!-- Run control -->
  <section class="card">
    <div class="row">
      <button id="startBtn" class="btn">Start My 30-Minute Run</button>
      <div><b>Timer:</b> <span id="timer">Not started</span></div>
      <a href="index.html" class="btn" style="margin-left:auto">← Round 1</a>
    </div>
    <div class="row" style="margin-top:8px">
      <div>Codename: <input id="name" type="text" placeholder="e.g., LanternFox"> <button id="saveName" class="btn">Save</button></div>
      <button id="resetRun" class="btn" style="margin-left:auto" title="Reset only Round-2 run">Reset Run</button>
    </div>
  </section>

  <!-- Enter code -->
  <section class="card">
    <h3>Enter a Code</h3>
    <div class="row">
      <input id="codeBox" type="text" maxlength="20" placeholder="Type the 6-char code (e.g., AD8CU8)">
      <button id="submitCode" class="btn">Claim</button>
    </div>
    <p class="small" style="margin-top:6px">Codes are printed on the hidden “Records of Atchison Gulch” half-sheets. Not case-sensitive.</p>
    <div class="small" id="foundStat" style="margin-top:6px">Found: 0 / 10 · Coins: 0 · Trade used: No</div>
  </section>

  <!-- Clue tracker -->
  <section class="card">
    <h3>Clues Found</h3>
    <div class="clues" id="clueGrid"></div>
  </section>

  <!-- Trade -->
  <section class="card">
    <h3>One Trade</h3>
    <p class="small">Once per run, agree with someone to <i>give</i> or <i>receive</i> 1 coin (honor system).</p>
    <button id="tradeBtn" class="btn">Use My Trade</button>
  </section>

  <!-- Ritual (appears on WIN) -->
  <section class="card" id="ritualCard" style="display:none">
    <h3>Final Ritual</h3>
    <p class="small">You won your run. Read together:</p>
    <blockquote><em>“Lantern rekindled, river released; song restored, and judgment ceased. From ridge to square, let grudges part—return what’s owed and mend the heart.”</em></blockquote>
    <button id="liftBtn" class="btn">Lift the Curse</button>
  </section>
</main>

<!-- Message Modal -->
<dialog id="msg">
  <div class="modal-head">
    <strong id="msgTitle">Message</strong>
    <button class="x" data-close="msg" aria-label="Close">Close</button>
  </div>
  <div class="modal-body" id="msgBody"></div>
</dialog>

<!-- Jump Scares -->
<div id="scare" aria-hidden="true"><div class="flash"></div><div class="face" role="img" aria-label="Wicked Willow appears"></div></div>
<div id="scareBad" aria-hidden="true"><div class="flash"></div><div class="face" role="img" aria-label="The curse follows you home"></div></div>

<script>
/* ===== Shared state ===== */
function S(){ try{return JSON.parse(localStorage.getItem('willow_qr')||'{}')}catch{return{}} }
function W(v){ localStorage.setItem('willow_qr', JSON.stringify(v)); }

/* ===== Settings ===== */
const TIME_LIMIT_MIN=30;
const FATE={ gain:0.55, lose:0.30, doom:0.15 };
const COIN_CHANGE={ gain:+2, lose:-1 };
const AUTO_WIN_POINTS = 10;

/* EXACT tokens for your printed half-sheets (10 total) */
const TOKENS = [
  'AD8CU8','75SHA7','W4ZQ6X','T3BT5T','BZV7V4','YJN2J7','SYBP7Z','CWD4WC','9TJVVK','ARTNPS'
];
const MSGS_WILLOW=[
  "“You blamed me for the dark—yet you dug the tunnel.”",
  "“Set down your fear and the dust will settle.”",
  "“Truth is a lantern: it burns, but it shows the way.”",
  "“Trade kindly; Atchison remembers debts.”"
];
const MSGS_DEAD=[
  "The canary fell silent… and so did we.",
  "We drown in dust, not water.",
  "Our bones line the riverbed of your choices.",
  "We whisper: let blame go, or be buried with it."
];

/* ===== UI refs ===== */
const startBtn=document.getElementById('startBtn');
const timerEl=document.getElementById('timer');
const nameInp=document.getElementById('name');
const saveName=document.getElementById('saveName');
const resetRun=document.getElementById('resetRun');

const codeBox=document.getElementById('codeBox');
const submitCode=document.getElementById('submitCode');
const foundStat=document.getElementById('foundStat');
const tradeBtn=document.getElementById('tradeBtn');

const ritualCard=document.getElementById('ritualCard');
const liftBtn=document.getElementById('liftBtn');

const msgDlg=document.getElementById('msg');
const msgTitle=document.getElementById('msgTitle');
const msgBody=document.getElementById('msgBody');

const clueGrid=document.getElementById('clueGrid');

let ticker=null;

/* ===== WebAudio (mobile-safe) ===== */
let audioCtx=null;
function primeAudio(){ try{ if(!audioCtx){ const C=window.AudioContext||window.webkitAudioContext; audioCtx=new C(); } if(audioCtx.state==='suspended') audioCtx.resume(); }catch(e){} }
function playSweep({good=true,duration=1.0}={}){ if(!audioCtx) return; const ctx=audioCtx; const g=ctx.createGain(); g.gain.value=0.0001; g.connect(ctx.destination); const o=ctx.createOscillator(); o.type='sawtooth'; const t0=ctx.currentTime+0.01,t1=t0+duration; const f1=good?520:140, f2=good?60:20; o.frequency.setValueAtTime(f1,t0); o.frequency.exponentialRampToValueAtTime(f2,t0+(good?0.45:0.9)); g.gain.setValueAtTime(0.0001,t0); g.gain.exponentialRampToValueAtTime(0.9,t0+0.06); g.gain.exponentialRampToValueAtTime(0.0001,t1); o.connect(g); o.start(t0); o.stop(t1); }

/* ===== Boot ===== */
(function boot(){
  // close any dialog with [data-close]
  document.addEventListener('click', (e)=>{ const btn=e.target.closest('[data-close]'); if(btn){ const id=btn.getAttribute('data-close'); const dlg=document.getElementById(id); dlg?.close(); }});
  // prime audio once
  ['click','touchstart'].forEach(ev=>document.addEventListener(ev, primeAudio, {once:true}));

  const s=S();
  if(s.name) nameInp.value=s.name;

  startBtn.onclick=()=>{ primeAudio(); startRun(); };
  saveName.onclick=()=>{ const s=S(); const n=(nameInp.value||'').trim(); if(!n) return alert('Pick a codename first.'); s.name=n; W(s); alert('Saved.'); };
  resetRun.onclick=()=>{ if(!confirm('Reset your current Round-2 run?')) return; const s=S(); delete s.r2; W(s); timerEl.textContent='Not started'; ritualCard.style.display='none'; paintClues(); updateFoundUI(); };

  submitCode.onclick=()=>{ primeAudio(); submitEnteredCode(); };
  codeBox.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); submitEnteredCode(); } });

  tradeBtn.onclick=()=>{ primeAudio(); useTrade(); };
  liftBtn.onclick=()=>{ primeAudio(); winRitual(); };

  // restore state
  if(s.r2){ paintClues(); updateFoundUI(); if(s.r2.startedAt && !s.r2.over) startTicker(); }
  else paintClues();
})();

/* ===== Timer & state ===== */
function startRun(){
  const s=S();
  if(s.r2 && s.r2.startedAt && !s.r2.over) return alert('Your run is already in progress!');
  const now=Date.now();
  s.r2={startedAt:now, endsAt:now+TIME_LIMIT_MIN*60000, points:0, found:{}, tradeUsed:false, doom:false, over:false, win:false};
  W(s); paintClues(); updateFoundUI(); startTicker(); alert('The lantern burns. Your hunt begins!');
}
function startTicker(){
  if(ticker) clearInterval(ticker);
  ticker=setInterval(()=>{
    const s=S(); if(!s.r2 || s.r2.over){ clearInterval(ticker); return; }
    const remain=s.r2.endsAt-Date.now();
    if(remain<=0){ s.r2.over=true; W(s); checkOutcome(); clearInterval(ticker); return; }
    const m=Math.floor(remain/60000), sec=Math.floor((remain%60000)/1000);
    timerEl.textContent=`${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
  },1000);
}

/* ===== UI painters ===== */
function paintClues(){
  const s=S();
  const found = s?.r2?.found || {};
  clueGrid.innerHTML='';
  TOKENS.forEach((tok, i)=>{
    const div=document.createElement('div');
    div.className='clue';
    const status=found[tok];
    if(status==='gain' || status==='lose') div.classList.add('s');
    if(status==='doom') div.classList.add('d');
    div.innerHTML=`<div class="n">CLUE ${i+1}</div><div class="small">${ status ? (status==='doom'?'☠️ DOOMED':'Claimed') : 'Unclaimed' }</div>`;
    clueGrid.appendChild(div);
  });
}
function updateFoundUI(){
  const s=S();
  const foundN = Object.keys(s?.r2?.found||{}).length;
  const coins = s?.r2?.points||0;
  const tradeUsed = s?.r2?.tradeUsed ? 'Yes' : 'No';
  foundStat.textContent = `Found: ${foundN} / ${TOKENS.length} · Coins: ${coins} · Trade used: ${tradeUsed}`;
}

/* ===== Fate + messages ===== */
function rollFate(){
  const r=Math.random();
  if(r < FATE.gain) return 'gain';
  if(r < FATE.gain + FATE.lose) return 'lose';
  return 'doom';
}
function showMsg(title, html){
  msgTitle.textContent=title; msgBody.innerHTML=html; msgDlg.showModal();
}
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

/* ===== Token entry ===== */
function normalizeToken(t){ return String(t||'').trim().toUpperCase(); }
function submitEnteredCode(){
  const t = normalizeToken(codeBox.value);
  if(!t) return alert('Enter a code from a CLUE sheet.');
  if(!TOKENS.includes(t)) return alert('That code is not recognized. Double-check the letters and numbers.');

  const s=S();
  if(!s.r2 || !s.r2.startedAt || s.r2.over) return alert('Start your 30-minute run first.');
  if(s.r2.doom) return alert('Your fate is sealed. The curse follows you.');
  if(s.r2.found && s.r2.found[t]) return alert('You already claimed this code.');

  const fate = rollFate();
  s.r2.found[t]=fate;

  if(fate==='gain'){ s.r2.points=(s.r2.points||0)+COIN_CHANGE.gain; showMsg('Willow Speaks', pick(MSGS_WILLOW)+`<br><br><b>Fate:</b> +${COIN_CHANGE.gain} coins`); }
  if(fate==='lose'){ s.r2.points=Math.max(0,(s.r2.points||0)+COIN_CHANGE.lose); showMsg('A Voice from the Shaft', pick(MSGS_DEAD)+`<br><br><b>Fate:</b> ${COIN_CHANGE.lose} coin`); }
  if(fate==='doom'){ s.r2.doom=true; s.r2.over=true; W(s); paintClues(); updateFoundUI(); return loseFlow('A Cold Hand', pick(MSGS_DEAD)+`<br><br><b>Fate:</b> <span style="color:#ff6b6b">DOOM</span>`); }

  W(s); paintClues(); updateFoundUI(); if(navigator.vibrate) navigator.vibrate(30);
  codeBox.value='';

  // Auto-win at 10+
  if(!s.r2.over && s.r2.points >= AUTO_WIN_POINTS){
    s.r2.over = true; s.r2.win = true; W(s);
    showMsg('Lantern Blazes', 'You gathered enough coin to sway the spirits. The ritual is ready.');
    return winFlow();
  }

  // Win if all codes found
  if(Object.keys(s.r2.found).length === TOKENS.length){
    s.r2.over=true; s.r2.win=true; W(s); winFlow();
  }
}

/* ===== Trade (once) ===== */
function useTrade(){
  const s=S();
  if(!s.r2 || s.r2.over || s.r2.doom) return alert('You need an active run.');
  if(s.r2.tradeUsed) return alert('Trade already used this run.');
  const dir = (prompt('Type "give" to give 1 coin, or "receive" to take 1 coin.')||'').toLowerCase();
  if(dir!=='give' && dir!=='receive') return;
  if(dir==='give') s.r2.points=Math.max(0,(s.r2.points||0)-1);
  if(dir==='receive') s.r2.points=(s.r2.points||0)+1;
  s.r2.tradeUsed=true; W(s); updateFoundUI(); alert('Trade complete.');
}

/* ===== Outcome flows ===== */
async function winFlow(){ ritualCard.style.display='block'; await jumpScare(true); }
async function loseFlow(title, html){ showMsg(title, html); await jumpScare(false); alert('☠️ You lost your run. Try again later… the curse lingers.'); }
function checkOutcome(){
  const s=S();
  if(s.r2.doom) return loseFlow('Your Footsteps Echo', 'The lantern goes dark. The curse finds your doorstep.');
  if((s.r2.points||0) >= AUTO_WIN_POINTS) return winFlow();
  if(Object.keys(s?.r2?.found||{}).length !== TOKENS.length) return loseFlow('Too Late','Midnight passes; the gulch exhales. The curse follows you home.');
  winFlow();
}

/* ===== Jump scares (overlay + WebAudio sound) ===== */
function jumpScare(good){
  return new Promise(res=>{
    primeAudio();
    const el = good ? document.getElementById('scare') : document.getElementById('scareBad');
    el.style.display='flex'; el.classList.add('scare-in');
    // sound sweep (mobile-safe)
    playSweep({good, duration: good?0.9:1.4});
    setTimeout(()=>{ el.style.display='none'; el.classList.remove('scare-in'); res(); }, good?1200:1600);
  });
}
function winRitual(){ alert('✨ The curse lifts! Show this to the host for your reward.'); }
</script>
</body>
</html>
